<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.scut.industrial_software.mapper.LicenseApplyMapper">

    <resultMap id="LicenseApplyResultMap" type="com.scut.industrial_software.model.entity.license.LicenseApply">
        <id property="requestId" column="request_id" />
        <result property="macAddress" column="mac_address" />
        <result property="status" column="status" />
        <result property="licensePath" column="license_path" />
        <result property="moduleId" column="module_id" />
        <result property="categoryId" column="category_id" />
        <result property="licenseNo" column="license_no" />
        <result property="validFrom" column="valid_from" />
        <result property="validTo" column="valid_to" />
        <result property="usageCount" column="usage_count" />
        <result property="createdAt" column="created_at" />
        <result property="userName" column="user_name" />
        <result property="customerName" column="customer_name" />
    </resultMap>

    <select id="selectByModuleAndStatus"
            resultMap="LicenseApplyResultMap"
            parameterType="map">
        <!-- MyBatis-Plus 分页插件根据 Page 参数自动追加 LIMIT 子句 -->
        SELECT
            request_id,
            mac_address,
            status,
            license_path,
            module_id,
            category_id,
            license_no,
            valid_from,
            valid_to,
            usage_count,
            created_at,
            user_name,
            customer_name
        FROM license_apply
        <where>
            <if test="moduleKeyword != null and moduleKeyword != ''">
                AND module_id LIKE CONCAT('%', #{moduleKeyword}, '%')
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
        </where>
        ORDER BY created_at DESC
    </select>

    <update id="updateLicenseFileInfo">
        UPDATE license_apply
        SET license_no = #{licenseNo},
            license_path = #{licensePath}
        WHERE request_id = #{requestId}
    </update>

</mapper>
